<template>
 
     
  <div class="row mb-4">
   <div id="form_grid_layouts" class="col-lg-12">
                             <div class="seperator-header">
                                 <h4 class="">Form Edit News</h4>
                             </div>
     </div>
         <div class="form-group mb-4">
           <label for="formGroupExampleInput">News Title</label>
           <input type="text" class="form-control" id="formGroupExampleInput" placeholder="News Title *" v-model="store.formDataNews.news_title"
           :class="{
                 'border-red-500 focus:border-red-500': v$.news_title.$error,
                 'border-[#42d392] ': !v$.news_title.$invalid,
               }"
               @change="v$.news_title.$touch"
              >
               <span class="text-xs text-red-500" style="color:red" v-if="v$.news_title.$error">{{
             v$.news_title.$errors[0].$message
           }}</span>
           </div>
           <div class="form-group mb-4"> 
             <label for="exampleFormControlTextarea1">News Description</label>
             <textarea class="form-control" id="exampleFormControlTextarea1" rows="3" 
             :class="{
                 'border-red-500 focus:border-red-500': v$.news_description.$error,
                 'border-[#42d392] ': !v$.news_description.$invalid,
               }"
               @change="v$.news_description.$touch"
               v-model="store.formDataNews.news_description">
               </textarea><span class="text-xs text-red-500" style="color:red" v-if="v$.news_description.$error">{{
             v$.news_description.$errors[0].$message
           }}</span>
           </div> 
           <div class="form-group mb-4 mt-3">
                                             <label for="exampleFormControlFile1">Example file input</label>
                                             <input type="file" class="form-control-file" :class="{
                 'border-red-500 focus:border-red-500': v$.file.$error,
                 'border-[#42d392] ': !v$.file.$invalid,
               }" id="exampleFormControlFile1" multiple @change="onFileChange" ref="fileupload">
                                         </div>
                                         <p style="color: red;">File size exceeds the limit 2 MB.</p>
                                         <div class="border p-2 mt-3">
             <p>Preview Here: </p>
             <template v-if="storeupload.preview_list.length">
               <div v-for="item, index in storeupload.preview_list" :key="index">
                 <img :src="CoverImage(item)" class="img-fluid" />
                <button @click="removeImage(index)">Remove image</button>
               </div>
              New {{ storeupload.preview_list }}
           
               
             </template>
           </div>
           <div>
 
   </div>
                {{ storeupload.data_list_image }}                         
 
 
     </div>
    
    
     <button type="button" class="btn btn-primary" @click="edit()">แก้ไข</button>      
 </template>
 <script setup lang="ts">
 import { storeToRefs } from 'pinia';
 import { defineComponent } from 'vue';
 import { newTransportStore } from '@/store/newstransport'; // import the auth store we just created
 import { useVuelidate } from '@vuelidate/core';
 import { required, email, sameAs, minLength, helpers } from '@vuelidate/validators';
 import { UploadStore } from '@/store/upload'; // import the auth store we just created
 import { AlertStore } from '@/store/alert'; // import the auth store we just created
 import { ref } from "vue";
 
 
 
 const router = useRouter();
 const store = newTransportStore()
 const storeupload = UploadStore()
 const storealert = AlertStore()
 
 
 
 const { Clear } = AlertStore(); // use  action
 const { UpdateFormNews } = newTransportStore(); // use  action
 const { getFormNews } = storeToRefs(store);
 const { Saveimages } = UploadStore(); // use authenticateUser action from  auth store
 
 
 
 storealert.Clear()

 await store.fetchNewsId(router.currentRoute.value.params.id)
 
 const rules = computed(() => {
   return {
     news_title: {
       required: helpers.withMessage('The News Title field is required', required),
       minLength: minLength(6),
     },
     news_description: {
       required: helpers.withMessage('The News Description is required', required),
       minLength: minLength(6),
     },
     file:{
      required: helpers.withMessage('The News Description is required', required),
     }
 

     
   };
 });



 
 

 
function CoverImage(x) {

  var result = x.slice(0, 6);


if (result === "static") {
  return 'https://oasapi.iddriver.com/media_file/file/?f='+ x;
} else {
  return x;
}



 }
 
 
 const v$ = useVuelidate(rules, getFormNews);

 const removeImage = async (remove) => {
  storeupload.preview_list.splice(remove, 1)
  storeupload.formi.splice(remove, 1)
  storeupload.data_list_image.splice(remove, 1)

}
 
 const edit = async () => {
  const new_image = ['x1','x2'];
  const same_image = ['x1','x2','x3'];
     v$.value.$validate();
     if (!v$.value.$error) {
  await UpdateFormNews(); //save form  ส่งไป Store User
   }
 }
 
 const onFileChange = async (event) => {
    

  
 
   var input = event.target;
       var count = input.files.length;
       var index = 0;


       
       for(let i = 0; i<count; i++)
	  {
		storeupload.formi.push(event.target.files[i]);
    }
 
    const formData = new FormData();
          for (const i of Object.keys(storeupload.formi)) {
            formData.append('files', storeupload.formi[i])
           
     }
 
 
   // await Saveimages();
 
       if (input.files) {
         while(count --) {
           var reader = new FileReader();
           reader.onload = (e) => {
   

             storeupload.preview_list.push(e.target.result);
             let a = { ni_name_file:e.target.result,ni_path_file:e.target.result}
             storeupload.data_list_image.push(a);
           }
           storeupload.image_list.push(input.files[index]);
           reader.readAsDataURL(input.files[index]);
           index ++;
         }
       }
 }
 


 
 
 </script>
 <style>
  .preview{
       display: flex;
       justify-content: center;
       align-items: center;
       height: 100px;
       width: 100px;
     }
 
 </style>
 